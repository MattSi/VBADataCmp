Option Explicit
Sub GetSwapRisk(CurveType As String)
    Dim ws As Worksheet
    Dim Row As Integer
    Dim rn As Integer
    Dim keyValue As String
    Dim dict As Object, key, val
    Dim destRange As Range
    Dim index As Integer
    Dim i As Integer
    Set ws = ActiveWorkbook.Sheets("result")
    Set dict = CreateObject("Scripting.Dictionary")
    
    Sheets("TestSummary").Select
    Set destRange = Range("A1:Z100")
    index = 1
    
    destRange.Cells(index, 1).Value = "Portfolio"
    destRange.Cells(index, 2).Value = "Curve Type"
    destRange.Cells(index, 3).Value = "FR007"
    destRange.Cells(index, 4).Value = "SHB3M"
    destRange.Cells(index, 5).Value = "DISC"
    
    index = index + 1
    
     
    rn = ws.UsedRange.Rows.Count
    For i = 2 To rn
        keyValue = ws.Cells(i, 8).Value
        If (Len(Trim(keyValue))) = 0 Then
            keyValue = "Empty"
        End If
        key = keyValue: val = keyValue
        If Not dict.exists(key) Then
            dict.Add key, val
        End If
    Next i
    
    For Each key In dict.keys
        If (StrComp(key, "Empty", vbTextCompare) = 0 Or StrComp(key, "0", vbTextCompare) = 0) Then
            GoTo Nextiteration
        End If
        Dim fixing_leg As Double
        Dim floating_s3m_leg As Double
        Dim floating_r7d_leg As Double
        fixing_leg = 0#
        floating_r7d_leg = 0#
        floating_s3m_leg = 0#
        For Row = 2 To rn
            If (Not ws.Cells(Row, 2).Value = "EOD" Or Not ws.Cells(Row, 8) = key Or Not ws.Cells(Row, 15) = "SOD" Or Not ws.Cells(Row, 12) = "SWAP" Or Not ws.Cells(Row, 50) = CurveType) Then
                ' Do nothing here
            Else
                If (ws.Cells(Row, 16).Value = "POS_FIXED") Then
                    If (IsNumeric(ws.Cells(Row, 52).Value)) Then
                        fixing_leg = fixing_leg + ws.Cells(Row, 52).Value
                    End If
                End If
                If (ws.Cells(Row, 16).Value = "POS_FLOAT" And ws.Cells(Row, 18) = "FR007") Then
                    If (IsNumeric(ws.Cells(Row, 52).Value)) Then
                        floating_r7d_leg = ws.Cells(Row, 52).Value
                    End If
                End If
                If (ws.Cells(Row, 16).Value = "POS_FLOAT" And ws.Cells(Row, 18) = "SHB3M") Then
                    If (IsNumeric(ws.Cells(Row, 52).Value)) Then
                        floating_s3m_leg = ws.Cells(Row, 52).Value
                    End If
                End If
            End If
        Next Row
        Debug.Print key, CurveType, floating_r7d_leg, floating_s3m_leg, fixing_leg
        destRange.Cells(index, 1).Value = key
        destRange.Cells(index, 2).Value = CurveType
        destRange.Cells(index, 3).Value = floating_r7d_leg
        destRange.Cells(index, 4).Value = floating_s3m_leg
        destRange.Cells(index, 5).Value = fixing_leg
        index = index + 1
Nextiteration:
    Next key
    
    Call saveSheet(destRange, "IT_SWAP_RISK_" + CurveType)
End Sub
Sub GetBondRisk(CurveType As String)
    Dim ws As Worksheet
    Dim Row As Integer
    Dim rn As Integer
    Dim keyValue As String
    Dim dict As Object, key, val
    Dim destRange As Range
    Dim index As Integer
    Dim i As Integer
    
    
    Set ws = ActiveWorkbook.Sheets("result")
    Set dict = CreateObject("Scripting.Dictionary")
    
    Sheets("TestSummary").Select
    Set destRange = Range("A1:Z100")
    index = 1
    
    destRange.Cells(index, 1).Value = "Portfolio"
    destRange.Cells(index, 2).Value = "Curve Type"
    destRange.Cells(index, 3).Value = "CGB"
    destRange.Cells(index, 4).Value = "CDB"
    destRange.Cells(index, 5).Value = "ADB"
    destRange.Cells(index, 6).Value = "EXIM"
    destRange.Cells(index, 7).Value = "CB"
    index = index + 1
    
    rn = ws.UsedRange.Rows.Count
    For i = 2 To rn
        keyValue = ws.Cells(i, 8).Value
        If (Len(Trim(keyValue))) = 0 Then
            keyValue = "Empty"
        End If
        key = keyValue: val = keyValue
        If Not dict.exists(key) Then
            dict.Add key, val
        End If
    Next i
    
    For Each key In dict.keys
        If (StrComp(key, "Empty", vbTextCompare) = 0 Or StrComp(key, "0", vbTextCompare) = 0) Then
            GoTo Nextiteration
        End If
        Dim cgb As Double
        Dim cdb As Double
        Dim adb As Double
        Dim exim As Double
        Dim cb As Double
        
        cgb = 0#
        cdb = 0#
        adb = 0#
        exim = 0#
        cb = 0#
        For Row = 2 To rn
            If (Not ws.Cells(Row, 2).Value = "EOD" Or Not ws.Cells(Row, 8) = key Or Not ws.Cells(Row, 15) = "SOD" Or Not ws.Cells(Row, 12) = "BOND" Or Not ws.Cells(Row, 50) = CurveType) Then
            Else
                If (ws.Cells(Row, 13).Value = "CDB") Then
                    If (IsNumeric(ws.Cells(Row, 52).Value)) Then
                        cdb = cdb + ws.Cells(Row, 52).Value
                    End If
                End If
                If (ws.Cells(Row, 13).Value = "CGB") Then
                    If (IsNumeric(ws.Cells(Row, 52).Value)) Then
                        cgb = cgb + ws.Cells(Row, 52).Value
                    End If
                End If
                If (ws.Cells(Row, 13).Value = "ADB") Then
                    If (IsNumeric(ws.Cells(Row, 52).Value)) Then
                        adb = adb + ws.Cells(Row, 52).Value
                    End If
                End If
                If (ws.Cells(Row, 13).Value = "EXIM") Then
                    If (IsNumeric(ws.Cells(Row, 52).Value)) Then
                        exim = exim + ws.Cells(Row, 52).Value
                    End If
                End If
                If (ws.Cells(Row, 13).Value = "CB") Then
                    If (IsNumeric(ws.Cells(Row, 52).Value)) Then
                        cb = cb + ws.Cells(Row, 52).Value
                    End If
                End If
            End If
        Next Row
        Debug.Print key, CurveType, cgb, cdb, adb, exim, cb
        destRange.Cells(index, 1).Value = key
        destRange.Cells(index, 2).Value = CurveType
        destRange.Cells(index, 3).Value = cgb
        destRange.Cells(index, 4).Value = cdb
        destRange.Cells(index, 5).Value = adb
        destRange.Cells(index, 6).Value = exim
        destRange.Cells(index, 7).Value = cb
        
        index = index + 1
Nextiteration:
    Next key
    Call saveSheet(destRange, "IT_BOND_RISK_" + CurveType)
End Sub
Sub GetSwapPV()
    Dim ws As Worksheet
    Dim Row As Integer
    Dim rn As Integer
    Dim keyValue As String
    Dim dict As Object, key, val
    Dim destRange As Range
    Dim index As Integer
    Dim i As Integer
    Dim SecType As String
    Dim ydayPVFixed As Double
    Dim tdayPVFixed As Double
    Dim ydayPVFloat As Double
    Dim tdayPVFloat As Double
    Set ws = ActiveWorkbook.Sheets("result")
    Set dict = CreateObject("Scripting.Dictionary")
    
    Sheets("TestSummary").Select
    Set destRange = Range("A1:Z100")
    index = 1
    
    destRange.Cells(index, 2).Value = "Portfolio"
    destRange.Cells(index, 3).Value = "Index"
    destRange.Cells(index, 4).Value = "Leg"
    destRange.Cells(index, 5).Value = "YDayPV"
    destRange.Cells(index, 6).Value = "EodPV"
    destRange.Cells(index, 1).Value = "Key"
    
    index = index + 1
    
     
    rn = ws.UsedRange.Rows.Count
    For i = 2 To rn
        keyValue = ws.Cells(i, 8).Value
        If (Len(Trim(keyValue))) = 0 Then
            keyValue = "Empty"
        End If
        key = keyValue: val = keyValue
        If Not dict.exists(key) Then
            dict.Add key, val
        End If
    Next i
    
    SecType = "FR007"
    For Each key In dict.keys
        If (StrComp(key, "Empty", vbTextCompare) = 0 Or StrComp(key, "0", vbTextCompare) = 0) Then
            GoTo Nextiteration
        End If
        ydayPVFixed = 0#
        tdayPVFixed = 0#
        ydayPVFloat = 0#
        tdayPVFloat = 0#
        
        For Row = 2 To rn
            If (Not ws.Cells(Row, 2).Value = "EOD" Or Not ws.Cells(Row, 8).Value = key Or Not ws.Cells(Row, 15).Value = "SOD" Or Not ws.Cells(Row, 12).Value = "SWAP" Or Not ws.Cells(Row, 50).Value = "IMM") Then
                'Do nothing here
                GoTo Nextiteration2
            End If
            ' if(ws.Cells( 1. Security ID
            If (ws.Cells(Row, 18).Value = SecType And ws.Cells(Row, 16) = "POS_FIXED" And IsNumeric(ws.Cells(Row, 34).Value) And IsNumeric(ws.Cells(Row, 35).Value)) Then
                ydayPVFixed = ydayPVFixed + ws.Cells(Row, 34).Value
                tdayPVFixed = tdayPVFixed + ws.Cells(Row, 35).Value
            End If
            
            If (ws.Cells(Row, 18).Value = SecType And ws.Cells(Row, 16).Value = "POS_FLOAT" And IsNumeric(ws.Cells(Row, 34).Value) And IsNumeric(ws.Cells(Row, 35).Value)) Then
                ydayPVFloat = ydayPVFloat + ws.Cells(Row, 34).Value
                tdayPVFloat = tdayPVFloat + ws.Cells(Row, 35).Value
            End If
                
            
Nextiteration2:
        Next Row
        Debug.Print key, SecType, "POS_FIXED", ydayPVFixed, tdayPVFixed
        Debug.Print key, SecType, "POS_FLOAT", ydayPVFloat, tdayPVFloat
                                                               
        destRange.Cells(index, 2).Value = key
        destRange.Cells(index, 3).Value = SecType
        destRange.Cells(index, 4).Value = "POS_FIXED"
        destRange.Cells(index, 5).Value = ydayPVFixed
        destRange.Cells(index, 6).Value = tdayPVFixed
        destRange.Cells(index, 1).Value = key + "_" + SecType + "_" + "POS_FIXED"
        index = index + 1
        
        destRange.Cells(index, 2).Value = key
        destRange.Cells(index, 3).Value = SecType
        destRange.Cells(index, 4).Value = "POS_FLOAT"
        destRange.Cells(index, 5).Value = ydayPVFloat
        destRange.Cells(index, 6).Value = tdayPVFloat
        destRange.Cells(index, 1).Value = key + "_" + SecType + "_" + "POS_FLOAT"
        index = index + 1
        
Nextiteration:
    Next key
    
    SecType = "SHB3M"
    For Each key In dict.keys
        If (StrComp(key, "Empty", vbTextCompare) = 0 Or StrComp(key, "0", vbTextCompare) = 0) Then
            GoTo Nextiteration3
        End If
        ydayPVFixed = 0#
        tdayPVFixed = 0#
        ydayPVFloat = 0#
        tdayPVFloat = 0#
        
        For Row = 2 To rn
            If (Not ws.Cells(Row, 2).Value = "EOD" Or Not ws.Cells(Row, 8).Value = key Or Not ws.Cells(Row, 15).Value = "SOD" Or Not ws.Cells(Row, 12).Value = "SWAP" Or Not ws.Cells(Row, 50).Value = "IMM") Then
                'Do nothing here
                GoTo Nextiteration4
            End If
            ' if(ws.Cells( 1. Security ID
            If (ws.Cells(Row, 18).Value = SecType And ws.Cells(Row, 16) = "POS_FIXED" And IsNumeric(ws.Cells(Row, 34).Value) And IsNumeric(ws.Cells(Row, 35).Value)) Then
                ydayPVFixed = ydayPVFixed + ws.Cells(Row, 34).Value
                tdayPVFixed = tdayPVFixed + ws.Cells(Row, 35).Value
            End If
            
            If (ws.Cells(Row, 18).Value = SecType And ws.Cells(Row, 16).Value = "POS_FLOAT" And IsNumeric(ws.Cells(Row, 34).Value) And IsNumeric(ws.Cells(Row, 35).Value)) Then
                ydayPVFloat = ydayPVFloat + ws.Cells(Row, 34).Value
                tdayPVFloat = tdayPVFloat + ws.Cells(Row, 35).Value
            End If
                
            
Nextiteration4:
        Next Row
        Debug.Print key, SecType, "POS_FIXED", ydayPVFixed, tdayPVFixed
        Debug.Print key, SecType, "POS_FLOAT", ydayPVFloat, tdayPVFloat
                                                               
        destRange.Cells(index, 2).Value = key
        destRange.Cells(index, 3).Value = SecType
        destRange.Cells(index, 4).Value = "POS_FIXED"
        destRange.Cells(index, 5).Value = ydayPVFixed
        destRange.Cells(index, 6).Value = tdayPVFixed
        destRange.Cells(index, 1).Value = key + "_" + SecType + "_" + "POS_FIXED"
        index = index + 1
        
        destRange.Cells(index, 2).Value = key
        destRange.Cells(index, 3).Value = SecType
        destRange.Cells(index, 4).Value = "POS_FLOAT"
        destRange.Cells(index, 5).Value = ydayPVFloat
        destRange.Cells(index, 6).Value = tdayPVFloat
        destRange.Cells(index, 1).Value = key + "_" + SecType + "_" + "POS_FLOAT"
        index = index + 1
        
Nextiteration3:
    Next key
    
    
    
    Call saveSheet(destRange, "IT_SWAP_PNL")
End Sub
Sub GetBondPnL()
    Dim ws As Worksheet
    Dim Row As Integer
    Dim rn As Integer
    Dim keyValue As String
    Dim dict As Object, key, val
    Dim destRange As Range
    Dim index As Integer
    Dim i As Integer
    
    Set ws = ActiveWorkbook.Sheets("result")
    Set dict = CreateObject("Scripting.Dictionary")
    
    Sheets("TestSummary").Range("A1:Z100").Clear
    Sheets("TestSummary").Select
    Set destRange = Range("A1:Z100")
    index = 1
    
    destRange.Cells(index, 2).Value = "Portfolio"
    destRange.Cells(index, 3).Value = "Bond"
    destRange.Cells(index, 4).Value = "Qty"
    destRange.Cells(index, 5).Value = "Type"
    destRange.Cells(index, 6).Value = "Acc Today"
    destRange.Cells(index, 7).Value = "ACC YDay"
    destRange.Cells(index, 8).Value = "Accrual"
    destRange.Cells(index, 9).Value = "Start Price"
    destRange.Cells(index, 10).Value = "End Price"
    destRange.Cells(index, 11).Value = "EOD PnL"
    destRange.Cells(index, 1).Value = "Key"
    index = index + 1
    
    rn = ws.UsedRange.Rows.Count
    For i = 2 To rn
        keyValue = ws.Cells(i, 8).Value
        If (Len(Trim(keyValue)) = 0) Then
            keyValue = "Empty"
        End If
        key = keyValue: val = keyValue
        If Not dict.exists(key) Then
            dict.Add key, val
        End If
    Next i
    
    For Each key In dict.keys
        If (StrComp(key, "Empty", vbTextCompare) = 0 Or StrComp(key, "0", vbTextCompare) = 0) Then
            GoTo Nextiteration
        End If
        
        For Row = 2 To rn
            Dim Direction As Integer
            Direction = 1
            If (Not ws.Cells(Row, 2).Value = "EOD" Or Not ws.Cells(Row, 8).Value = key Or Not ws.Cells(Row, 15).Value = "SOD" Or Not ws.Cells(Row, 12).Value = "BOND" Or Not ws.Cells(Row, 50).Value = "IMM") Then
                GoTo Nextiteration2
            End If
            
            If (ws.Cells(Row, 17).Value = "SELL") Then
                Direction = -1
            End If
            
            destRange.Cells(index, 2).Value = ws.Cells(Row, 8).Value 'Column 1: Portfolio
            destRange.Cells(index, 3).Value = ws.Cells(Row, 18).Value 'Column 2: Bond Id
            destRange.Cells(index, 4).Value = ws.Cells(Row, 19).Value * Direction 'Column 3: Qty
            destRange.Cells(index, 5).Value = ws.Cells(Row, 13).Value 'Column 4: Product type
            destRange.Cells(index, 6).Value = ws.Cells(Row, 46).Value 'Column 5: Accrual Start
            destRange.Cells(index, 7).Value = ws.Cells(Row, 45).Value 'Column 6: Accrual End
            destRange.Cells(index, 8).Value = ws.Cells(Row, 41).Value 'Column 7: Accrual
            destRange.Cells(index, 9).Value = ws.Cells(Row, 34).Value 'Column 8: Start Price
            destRange.Cells(index, 10).Value = ws.Cells(Row, 35).Value 'Column 9: End Price
            destRange.Cells(index, 11).Value = ws.Cells(Row, 44).Value 'Column 10: Total PnL
            destRange.Cells(index, 1).Value = ws.Cells(Row, 8).Value + "_" + ws.Cells(Row, 18).Value
            index = index + 1
            
Nextiteration2:
        Next Row
Nextiteration:
    Next key
     Call saveSheet(destRange, "IT_BOND_PNL")
End Sub
Sub GetFuturePnL()
    Dim ws As Worksheet
    Dim Row As Integer
    Dim rn As Integer
    Dim keyValue As String
    Dim dict As Object, key, val
    Dim destRange As Range
    Dim index As Integer
    Dim i As Integer
    Dim j As Integer
    Dim pnlKey As String
    
    Set ws = ActiveWorkbook.Sheets("result")
    Set dict = CreateObject("Scripting.Dictionary")
    
    Sheets("TestSummary").Range("A1:Z100").Clear
    Sheets("TestSummary").Select
    Set destRange = Range("A1:Z100")
    index = 1
        
    destRange.Cells(index, 2).Value = "Portfolio"
    destRange.Cells(index, 3).Value = "Bond"
    destRange.Cells(index, 4).Value = "Qty"
    destRange.Cells(index, 5).Value = "Start Price"
    destRange.Cells(index, 6).Value = "End Price"
    destRange.Cells(index, 7).Value = "EOD PnL"
    destRange.Cells(index, 1).Value = "Key"
    index = index + 1
    
    rn = ws.UsedRange.Rows.Count
    For i = 2 To rn
        keyValue = ws.Cells(i, 8).Value
        If (Len(Trim(keyValue)) = 0) Then
            keyValue = "Empty"
        End If
        key = keyValue: val = keyValue
        If Not dict.exists(key) Then
            dict.Add key, val
        End If
    Next i
    
    For Each key In dict.keys
        If (StrComp(key, "Empty", vbTextCompare) = 0 Or StrComp(key, "0", vbTextCompare) = 0) Then
            GoTo Nextiteration
        End If
        
        For Row = 2 To rn
            Dim Direction As Integer
            Direction = 1
            If (Not ws.Cells(Row, 2).Value = "EOD" Or Not ws.Cells(Row, 8).Value = key Or Not ws.Cells(Row, 15).Value = "SOD" Or Not ws.Cells(Row, 12).Value = "FUT" Or Not ws.Cells(Row, 50).Value = "IMM") Then
                GoTo Nextiteration2
            End If
            
            If (ws.Cells(Row, 17).Value = "SHORT") Then
                Direction = -1
            End If
        
            pnlKey = ws.Cells(Row, 8).Value + "_" + ws.Cells(Row, 18).Value

            For j = 2 To index
                If (StrComp(destRange.Cells(j, 1).Value, pnlKey, vbBinaryCompare) = 0) Then

                    destRange.Cells(j, 4).Value = destRange.Cells(j, 4).Value + ws.Cells(Row, 19).Value * Direction 'Column 3: Qty
                    destRange.Cells(j, 7).Value = destRange.Cells(j, 7).Value + ws.Cells(Row, 44) 'Column 10: Total PnL
                    'index = index + 1
                    GoTo Nextiteration2
                End If
            Next j
            
            destRange.Cells(index, 2).Value = ws.Cells(Row, 8).Value 'Column 1: Portfolio
            destRange.Cells(index, 3).Value = ws.Cells(Row, 18).Value 'Column 2: Bond Id
            destRange.Cells(index, 4).Value = ws.Cells(Row, 19).Value * Direction 'Column 3: Qty
            destRange.Cells(index, 5).Value = ws.Cells(Row, 34) 'Column 8: Start Price
            destRange.Cells(index, 6).Value = ws.Cells(Row, 35) 'Column 9: End Price
            destRange.Cells(index, 7).Value = ws.Cells(Row, 44) 'Column 10: Total PnL
            destRange.Cells(index, 1).Value = ws.Cells(Row, 8).Value + "_" + ws.Cells(Row, 18).Value
            index = index + 1
            
Nextiteration2:
        Next Row
Nextiteration:
    Next key
     Call saveSheet(destRange, "IT_FUTURE_PNL")
End Sub
Sub saveSheet(rng As Range, fileName As String)
    Dim mypath As String
    Dim currWorkBook As Workbook
    Dim saveSheet As Worksheet
    Dim saveFile As Workbook
    rng.Copy
    
    Workbooks.Add
    ActiveSheet.Paste
    Application.CutCopyMode = False
    Selection.NumberFormat = "0.00000_);[red](0.00000)"
    
    ActiveWorkbook.SaveAs fileName:="D:\datacomp\" + fileName + ".xlsx", FileFormat:=xlOpenXMLWorkbook, CreateBackup:=False
    ActiveWorkbook.Close
    rng.Clear
    
End Sub
Sub CalculateRisk()
    Call GetSwapRisk("PAR")
    Call GetSwapRisk("IMM")
    Call GetBondRisk("PAR")
    Call GetBondRisk("IMM")
    Call GetSwapPV
    Call GetBondPnL
    Call GetFuturePnL
End Sub





